# 모바일 로그인 안정성 가이드 (Auth Stability Guide)

> **작성일:** 2026-01-26  
> **중요도:** CRITICAL (절대 변경 금지)

## 🚨 핵심 원칙
모바일 환경에서도 Google 로그인은 **반드시 `signInWithPopup` (팝업 방식)을 사용**해야 합니다.  
`signInWithRedirect` (리다이렉트 방식) 사용을 **엄격히 금지**합니다.

---

## 💥 `signInWithRedirect` 사용 시 문제점
과거(`e7dcbfb` 커밋 등) 리다이렉트 방식을 도입했을 때 다음과 같은 치명적인 오류가 발생했습니다:

1.  **무한 재로그인 루프 (Infinite Loop):**
    *   사용자가 구글 로그인 페이지로 이동했다가 앱으로 복귀(Redirect Callback)합니다.
    *   앱이 초기화되면서 `App.jsx`의 **뒤로가기 방지(`popstate`) 로직**이 실행됩니다.
    *   이 로직이 `history.pushState`를 호출하여 **URL의 인증 파라미터(Auth Token)를 강제로 제거**해버립니다.
    *   Firebase SDK는 인증 정보를 찾지 못해 로그인을 실패 처리하고, 다시 로그인 화면을 띄웁니다.
    *   사용자는 계속 로그인을 시도하게 되고, 이 과정이 무한 반복됩니다.

2.  **세션 유실 (Session Loss):**
    *   PWA(홈 화면 추가) 모드나 인앱 브라우저(카카오톡, 라인 등)에서는 리다이렉트 시 **새로운 브라우저 컨텍스트**가 열리거나 쿠키가 공유되지 않아 로그인이 풀리는 현상이 빈번합니다.
    *   Firebase Dynamic Links 지원 종료로 인해 리다이렉트 처리의 신뢰성이 낮아졌습니다.

---

## ✅ 해결된 아키텍처 (`signInWithPopup`)
`signInWithPopup`을 사용하면 다음과 같은 장점이 있습니다:

1.  **앱 컨텍스트 유지:** 현재 앱 화면이 닫히거나 새로고침되지 않고, 별도의 팝업 창에서 인증이 진행됩니다.
2.  **URL 보존:** 앱이 재로드되지 않으므로 URL 파라미터 초기화 문제가 발생하지 않습니다.
3.  **App.jsx와 호환:** `popstate` 로직(뒤로가기 방지)은 로그인이 완료된 **후**에만 활성화되므로 충돌하지 않습니다.
4.  **Service Worker 호환:** 네트워크 요청이 단순해져 Service Worker의 캐싱 간섭을 받지 않습니다.

## 🛡️ 코드 보호 조치
다음 파일들에 `[CRITICAL]` 주석을 추가하여 수정을 방지하였습니다:

*   `src/components/Login.jsx`
*   `src/contexts/AuthContext.jsx`

> **Note:** 향후 누군가 "모바일 UX 개선"을 이유로 리다이렉트 방식을 제안하더라도, 위에서 언급한 기술적 충돌 문제가 완전히 해결(예: Popstate 로직 제거 등)되지 않는 한 변경해서는 안 됩니다.
